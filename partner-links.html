<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Partner Links • Partner Report</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="data:,">
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="Manage partner social media and promotional links">
  
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  
  <!-- API Manager -->
  <script src="api-manager.js"></script>
  <script src="chartjs-adapter.js"></script>
  
  <!-- Theme toggle (load first to prevent flash) -->
  <script src="theme-toggle.js"></script>
  <!-- Burger menu with all controls -->
  <script src="burger-menu.js"></script>
  <script defer src="script.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <h1>Partner Report</h1>
      </div>
      <nav class="side-nav">
        <a href="index.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-7 9 7v10a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2V10z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Home</span></a>
        <a href="clients.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Clients</span></a>
        <a href="commissions.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 19h16M4 15l4-4 3 3 6-6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Commissions</span></a>
        <a href="client-lifecycle.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Client Lifecycle</span></a>
        <a href="master-partner.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l7 4v6c0 5-7 8-7 8s-7-3-7-8V7l7-4z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Master Partner</span></a>
        <a href="events.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Events</span></a>
        <a href="tiers-badges.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 6 1-4.5 4.4L17 21l-5-2.6L7 21l1.5-6.6L4 10l6-1 2-6z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Tiers &amp; Badges</span></a>
        <a href="client-funnel.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Client Funnel</span></a>
        <a href="country-analysis.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M3 12h18M12 3a15 15 0 0 1 0 18M12 3a15 15 0 0 0 0 18" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Country Analysis</span></a>
        <a href="partner-links.html" class="active"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Partner Links</span></a>
        <a href="sitemap.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M10 3h4v4h-4V3zM4 17h4v4H4v-4zm12 0h4v4h-4v-4zM12 7v4m0 0H7v6m5-6h5v6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Sitemap</span></a>
        <a href="database.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="5" rx="8" ry="3" stroke="currentColor" stroke-width="2"/><path d="M4 5v6c0 1.7 3.6 3 8 3s8-1.3 8-3V5M4 11v6c0 1.7 3.6 3 8 3s8-1.3 8-3v-6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Database</span></a>
      </nav>
      
      <!-- Country Manager Info -->
      <div class="country-manager-info">
        <div class="manager-name" id="country-manager-name">Loading...</div>
        <div class="manager-contact">
          <span class="manager-tel" id="country-manager-tel">Loading...</span>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="container">
        <header>
          <h1 class="page-title">Partner Links Management</h1>
          <p class="page-subtitle">Manage your social media and promotional links to enhance partner recommendations</p>
        </header>

        <main class="panel">
          <!-- Partner Selection -->
          <div class="card" style="margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Select Partner</h3>
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
              <select id="partnerSelect" style="flex: 1; min-width: 200px;">
                <option value="">Loading partners...</option>
              </select>
              <div id="partnerTier" class="tier-tag" style="display: none;"></div>
            </div>
          </div>

          <!-- Add New Link Form -->
          <div class="card" style="margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Add New Link</h3>
            <form id="addLinkForm" style="display: grid; gap: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
                <div>
                  <label for="linkType" style="display: block; margin-bottom: 8px; font-weight: 500;">Link Type</label>
                  <select id="linkType" required>
                    <option value="">Select type...</option>
                    <option value="website">Website</option>
                    <option value="youtube">YouTube</option>
                    <option value="facebook">Facebook</option>
                    <option value="instagram">Instagram</option>
                    <option value="twitter">Twitter</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="tiktok">TikTok</option>
                    <option value="telegram">Telegram</option>
                    <option value="discord">Discord</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label for="linkUrl" style="display: block; margin-bottom: 8px; font-weight: 500;">URL</label>
                  <input type="url" id="linkUrl" placeholder="https://example.com" required>
                </div>
              </div>
              
              <div>
                <label for="linkTitle" style="display: block; margin-bottom: 8px; font-weight: 500;">Title</label>
                <input type="text" id="linkTitle" placeholder="Enter a descriptive title">
              </div>
              
              <div>
                <label for="linkDescription" style="display: block; margin-bottom: 8px; font-weight: 500;">Description</label>
                <textarea id="linkDescription" rows="3" placeholder="Describe the content or purpose of this link"></textarea>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label for="followerCount" style="display: block; margin-bottom: 8px; font-weight: 500;">Follower Count</label>
                  <input type="number" id="followerCount" placeholder="0" min="0">
                </div>
                <div>
                  <label for="engagementRate" style="display: block; margin-bottom: 8px; font-weight: 500;">Engagement Rate (%)</label>
                  <input type="number" id="engagementRate" placeholder="0.0" min="0" max="100" step="0.1">
                </div>
              </div>
              
              <div style="display: flex; gap: 12px; align-items: center;">
                <button type="submit" class="btn-primary">Add Link</button>
                <button type="button" id="clearForm" class="btn-secondary">Clear</button>
              </div>
            </form>
          </div>

          <!-- Current Links Display -->
          <div class="card">
            <h3 style="margin-top: 0;">Current Links</h3>
            <div id="linksList" style="min-height: 200px;">
              <p class="muted" style="text-align: center; padding: 40px;">Select a partner to view their links</p>
            </div>
          </div>

          <!-- Link Analytics -->
          <div class="card" style="margin-top: 24px;">
            <h3 style="margin-top: 0;">Link Performance Analytics</h3>
            <div id="linkAnalytics" style="min-height: 300px;">
              <p class="muted" style="text-align: center; padding: 40px;">Analytics will appear here when links are available</p>
            </div>
          </div>
        </main>
      </div>
    </main>
  </div>

  <script>
    // Partner Links Management JavaScript
    (function() {
      'use strict';
      
      let currentPartnerId = null;
      let partnerLinks = [];
      
      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        loadPartners();
        setupEventListeners();
      });
      
      // Load partners for dropdown
      function loadPartners() {
        fetch('api/index.php?endpoint=partners')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const select = document.getElementById('partnerSelect');
              select.innerHTML = '<option value="">Select a partner...</option>';
              
              data.data.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner.partner_id;
                option.textContent = `${partner.name} (${partner.tier})`;
                select.appendChild(option);
              });
            }
          })
          .catch(error => {
            console.error('Error loading partners:', error);
            document.getElementById('partnerSelect').innerHTML = '<option value="">Error loading partners</option>';
          });
      }
      
      // Setup event listeners
      function setupEventListeners() {
        // Partner selection
        document.getElementById('partnerSelect').addEventListener('change', function() {
          currentPartnerId = this.value;
          if (currentPartnerId) {
            loadPartnerLinks(currentPartnerId);
            updatePartnerTier(this.options[this.selectedIndex].textContent);
          } else {
            clearLinksDisplay();
          }
        });
        
        // Add link form
        document.getElementById('addLinkForm').addEventListener('submit', function(e) {
          e.preventDefault();
          addNewLink();
        });
        
        // Clear form
        document.getElementById('clearForm').addEventListener('click', function() {
          document.getElementById('addLinkForm').reset();
        });
      }
      
      // Load partner links
      function loadPartnerLinks(partnerId) {
        fetch(`api/index.php?endpoint=partner_links&partner_id=${partnerId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              partnerLinks = data.data;
              displayLinks(partnerLinks);
              updateAnalytics(partnerLinks);
            } else {
              partnerLinks = [];
              displayLinks([]);
            }
          })
          .catch(error => {
            console.error('Error loading partner links:', error);
            partnerLinks = [];
            displayLinks([]);
          });
      }
      
      // Display links
      function displayLinks(links) {
        const container = document.getElementById('linksList');
        
        if (links.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">No links found for this partner</p>';
          return;
        }
        
        const linksHtml = links.map(link => `
          <div class="link-item" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span class="link-type-badge" style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; text-transform: uppercase;">
                    ${link.link_type}
                  </span>
                  ${link.is_verified ? '<span style="color: var(--success);">✓ Verified</span>' : ''}
                </div>
                <h4 style="margin: 0 0 4px 0;">${link.link_title || 'Untitled Link'}</h4>
                <a href="${link.link_url}" target="_blank" style="color: var(--accent); text-decoration: none;">
                  ${link.link_url}
                </a>
                ${link.description ? `<p style="margin: 8px 0 0 0; color: var(--muted); font-size: 14px;">${link.description}</p>` : ''}
              </div>
              <div style="text-align: right;">
                <button onclick="deleteLink(${link.id})" style="background: var(--error); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                  Delete
                </button>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
              <div style="text-align: center;">
                <div style="font-size: 18px; font-weight: 600; color: var(--accent);">${link.follower_count.toLocaleString()}</div>
                <div style="font-size: 12px; color: var(--muted);">Followers</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 18px; font-weight: 600; color: var(--success);">${link.engagement_rate}%</div>
                <div style="font-size: 12px; color: var(--muted);">Engagement</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 12px; color: var(--muted);">Updated</div>
                <div style="font-size: 12px; color: var(--muted);">${new Date(link.last_updated).toLocaleDateString()}</div>
              </div>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = linksHtml;
      }
      
      // Add new link
      function addNewLink() {
        if (!currentPartnerId) {
          alert('Please select a partner first');
          return;
        }
        
        const formData = {
          partner_id: currentPartnerId,
          link_type: document.getElementById('linkType').value,
          link_url: document.getElementById('linkUrl').value,
          link_title: document.getElementById('linkTitle').value,
          description: document.getElementById('linkDescription').value,
          follower_count: parseInt(document.getElementById('followerCount').value) || 0,
          engagement_rate: parseFloat(document.getElementById('engagementRate').value) || 0
        };
        
        fetch('api/index.php?endpoint=partner_links', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Link added successfully!');
            document.getElementById('addLinkForm').reset();
            loadPartnerLinks(currentPartnerId);
          } else {
            alert('Error adding link: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error adding link:', error);
          alert('Error adding link. Please try again.');
        });
      }
      
      // Delete link
      window.deleteLink = function(linkId) {
        if (!confirm('Are you sure you want to delete this link?')) {
          return;
        }
        
        fetch(`api/index.php?endpoint=partner_links&id=${linkId}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Link deleted successfully!');
            loadPartnerLinks(currentPartnerId);
          } else {
            alert('Error deleting link: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error deleting link:', error);
          alert('Error deleting link. Please try again.');
        });
      };
      
      // Update partner tier display
      function updatePartnerTier(partnerText) {
        const tierMatch = partnerText.match(/\(([^)]+)\)/);
        if (tierMatch) {
          const tier = tierMatch[1];
          const tierElement = document.getElementById('partnerTier');
          tierElement.textContent = tier;
          tierElement.className = `tier-tag tier-${tier.toLowerCase()}`;
          tierElement.style.display = 'inline-block';
        }
      }
      
      // Update analytics
      function updateAnalytics(links) {
        const container = document.getElementById('linkAnalytics');
        
        if (links.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">No analytics available</p>';
          return;
        }
        
        // Calculate analytics
        const totalFollowers = links.reduce((sum, link) => sum + link.follower_count, 0);
        const avgEngagement = links.reduce((sum, link) => sum + link.engagement_rate, 0) / links.length;
        const linkTypes = [...new Set(links.map(link => link.link_type))];
        
        const analyticsHtml = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div class="card" style="text-align: center;">
              <h4 style="margin: 0 0 8px 0;">Total Followers</h4>
              <div style="font-size: 24px; font-weight: 600; color: var(--accent);">${totalFollowers.toLocaleString()}</div>
            </div>
            <div class="card" style="text-align: center;">
              <h4 style="margin: 0 0 8px 0;">Avg Engagement</h4>
              <div style="font-size: 24px; font-weight: 600; color: var(--success);">${avgEngagement.toFixed(1)}%</div>
            </div>
            <div class="card" style="text-align: center;">
              <h4 style="margin: 0 0 8px 0;">Platforms</h4>
              <div style="font-size: 24px; font-weight: 600; color: var(--warning);">${linkTypes.length}</div>
            </div>
            <div class="card" style="text-align: center;">
              <h4 style="margin: 0 0 8px 0;">Total Links</h4>
              <div style="font-size: 24px; font-weight: 600; color: var(--info);">${links.length}</div>
            </div>
          </div>
        `;
        
        container.innerHTML = analyticsHtml;
      }
      
      // Clear links display
      function clearLinksDisplay() {
        document.getElementById('linksList').innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">Select a partner to view their links</p>';
        document.getElementById('linkAnalytics').innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">Analytics will appear here when links are available</p>';
        document.getElementById('partnerTier').style.display = 'none';
      }
      
    })();
  </script>
</body>
</html>
