<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Database • Partner Report</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="data:,">
  <meta name="color-scheme" content="dark light">
  <meta name="description" content="Database viewer with CRUD operations">
  <!-- Theme toggle (load first to prevent flash) -->
  <script src="theme-toggle.js"></script>
  <script src="database-crud.js"></script>
  <script defer src="script.js"></script>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid rgba(148,163,184,0.2); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .table-wrap { overflow-x: auto; max-height: 400px; overflow-y: auto; }
    .section { margin-bottom: 28px; }
    
    .tabs { display: flex; border-bottom: 1px solid rgba(148,163,184,0.2); margin-bottom: 16px; }
    .tab { padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); transition: all 0.15s ease; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <h1>Partner Report</h1>
      </div>
      <nav class="side-nav">
        <a href="index.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-7 9 7v10a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2V10z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Home</span></a>
        <a href="clients.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Clients</span></a>
        <a href="commissions.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 19h16M4 15l4-4 3 3 6-6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Commissions</span></a>
        <a href="master-partner.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l7 4v6c0 5-7 8-7 8s-7-3-7-8V7l7-4z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Master Partner</span></a>
        <a href="events.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Events</span></a>
        <a href="tiers-badges.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l3 6 6 1-4.5 4.4L17 21l-5-2.6L7 21l1.5-6.6L4 10l6-1 2-6z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Tiers &amp; Badges</span></a>
        <a href="client-funnel.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Client Funnel</span></a>
        <a href="country-analysis.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M3 12h18M12 3a15 15 0 0 1 0 18M12 3a15 15 0 0 0 0 18" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Country Analysis</span></a>
        <a href="sitemap.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M10 3h4v4h-4V3zM4 17h4v4H4v-4zm12 0h4v4h-4v-4zM12 7v4m0 0H7v6m5-6h5v6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Sitemap</span></a>
        <a href="database.html"><span class="icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><ellipse cx="12" cy="5" rx="8" ry="3" stroke="currentColor" stroke-width="2"/><path d="M4 5v6c0 1.7 3.6 3 8 3s8-1.3 8-3V5M4 11v6c0 1.7 3.6 3 8 3s8-1.3 8-3v-6" stroke="currentColor" stroke-width="2"/></svg></span><span class="label">Database</span></a>
      </nav>
    </aside>
    <div class="content">
      <!-- Theme Toggle -->
      <div class="theme-toggle-container">
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
          <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
      </div>

      <div class="container">
        <main class="panel">
          <h2 class="page-title">Database</h2>
          <p class="page-subtitle">MySQL database tables with CRUD operations</p>

          <div id="content"></div>

          <div class="footer">v1.0 • Static template</div>
        </main>
      </div>
    </div>
  </div>

  <script>
    function createTableFromArray(arr) {
      if (!Array.isArray(arr) || arr.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'card';
        empty.textContent = 'No rows';
        return empty;
      }
      var columns = Array.from(new Set(arr.flatMap(function (row) { return Object.keys(row); })));
      var wrap = document.createElement('div');
      wrap.className = 'card table-wrap';
      var table = document.createElement('table');
      var thead = document.createElement('thead');
      var trHead = document.createElement('tr');
      columns.forEach(function (col) {
        var th = document.createElement('th'); th.textContent = col; trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      var tbody = document.createElement('tbody');
      arr.forEach(function (row) {
        var tr = document.createElement('tr');
        columns.forEach(function (col) {
          var td = document.createElement('td');
          var v = row[col];
          td.textContent = (v == null) ? '' : (typeof v === 'object' ? JSON.stringify(v) : v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
      wrap.appendChild(table);
      return wrap;
    }

    // Show loading state
    var content = document.getElementById('content');
    var loading = document.createElement('div');
    loading.className = 'card';
    loading.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner"></div><p style="margin-top: 16px; color: var(--muted);">Loading database tables from MySQL...</p></div>';
    content.appendChild(loading);

    // Load data from MySQL via API
    Promise.all([
      fetch('api/index.php?endpoint=partners').then(r => r.json()),
      fetch('api/index.php?endpoint=clients').then(r => r.json()),
      window.ApiManager ? window.ApiManager.loadDashboardData() : fetch('api/index.php?endpoint=dashboard').then(r => r.json())
    ])
      .then(function (responses) {
        var partnersResp = responses[0];
        var clientsResp = responses[1];
        var dashboardResp = responses[2];
        
        // Extract data from API responses
        var db = {
          partners: partnersResp.success ? partnersResp.data : [],
          clients: clientsResp.success ? clientsResp.data : [],
          trades: dashboardResp.success ? dashboardResp.data.trades : (dashboardResp.trades || []),
          deposits: dashboardResp.success ? dashboardResp.data.deposits : (dashboardResp.deposits || [])
        };
        
        console.log('✓ Loaded database tables from MySQL:', {
          partners: db.partners.length,
          clients: db.clients.length,
          trades: db.trades.length,
          deposits: db.deposits.length
        });
        
        // Clear loading message
        content.innerHTML = '';
        
        var sections = [
          { key: 'partners', title: 'Partners' },
          { key: 'clients', title: 'Clients' },
          { key: 'trades', title: 'Trades' },
          { key: 'deposits', title: 'Deposits' }
        ];
        
        // Create tabs
        var tabsContainer = document.createElement('div');
        tabsContainer.className = 'tabs';
        sections.forEach(function(section, index) {
          var tab = document.createElement('div');
          tab.className = 'tab' + (index === 0 ? ' active' : '');
          tab.textContent = section.title + ' (' + (db[section.key] ? db[section.key].length : 0) + ')';
          tab.addEventListener('click', function() {
            // Remove active from all tabs and contents
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            // Add active to clicked tab and corresponding content
            tab.classList.add('active');
            document.getElementById('tab-' + section.key).classList.add('active');
          });
          tabsContainer.appendChild(tab);
        });
        content.appendChild(tabsContainer);
        
        // Create tab contents
        sections.forEach(function(section, index) {
          var tabContent = document.createElement('div');
          tabContent.id = 'tab-' + section.key;
          tabContent.className = 'tab-content' + (index === 0 ? ' active' : '');
          var s = document.createElement('section');
          s.className = 'section';
          var h3 = document.createElement('h3'); 
          h3.textContent = section.title + ' (' + (db[section.key] ? db[section.key].length : 0) + ' records)'; 
          s.appendChild(h3);
          
          // Use CRUD-enabled table for all tables
          if (window.DatabaseCRUD) {
            s.appendChild(window.DatabaseCRUD.createTable(db[section.key] || [], section.key));
          } else {
            s.appendChild(createTableFromArray(db[section.key] || []));
          }
          
          tabContent.appendChild(s);
          content.appendChild(tabContent);
        });
      })
      .catch(function (e) {
        content.innerHTML = '';
        var err = document.createElement('div'); 
        err.className = 'card';
        err.style.background = 'rgba(239, 68, 68, 0.1)';
        err.style.borderColor = '#ef4444';
        err.innerHTML = '<h3 style="color: #ef4444; margin-top: 0;">⚠️ Database Connection Error</h3>' +
          '<p>Failed to load data from MySQL database.</p>' +
          '<p style="color: var(--muted); font-size: 14px;">Error: ' + String(e) + '</p>' +
          '<div style="margin-top: 16px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">' +
          '<strong>Troubleshooting:</strong>' +
          '<ol style="margin: 8px 0; padding-left: 20px; color: var(--muted);">' +
          '<li>Ensure MySQL server is running</li>' +
          '<li>Check that PHP server is running: <code>php -S localhost:8000</code></li>' +
          '<li>Verify database is populated: <code>mysql -u root -p partner_report</code></li>' +
          '<li>Check API endpoints are accessible</li>' +
          '<li>Review browser console for detailed errors (F12)</li>' +
          '</ol></div>';
        content.appendChild(err);
        console.error('Database loading error:', e);
      });
  </script>
</body>
</html>


